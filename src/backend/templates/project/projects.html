{% extends "base.html" %}

{% import "macros.html" as macros %}

{% block title %}Project List{% endblock %}

{% block content %}

<h1 class="text-2xl mb-4 flex items-center">
    Projects
    {{ macros.svg_link("/project/create") }}
</h1>

<div class="mb-4 flex justify-between items-center gap-4">
  <!-- Search and Advanced Filter form on the left -->
  <form method="get" class="flex items-center gap-2">
    <!-- Search Input -->
    <input
      type="text"
      name="search"
      placeholder="Search projects..."
      value="{{ search or '' }}"
      class="px-4 py-2 border rounded-lg w-64"
    />

    <!-- Filter Field Dropdown -->
    <select name="filter_field" class="px-4 py-2 border rounded-lg">
    <option value="" class="text-gray-400">-- Select Field --</option>
    {% for header in headers %}
        {% if header not in ['Actions'] %}
        <option value="{{ header }}" {% if filter_field == header %}selected{% endif %}>
            {{ header }}
        </option>
        {% endif %}
    {% endfor %}
    </select>

    <!-- Filter Operator Dropdown -->
    <select name="filter_operator" class="px-4 py-2 border rounded-lg">
      <option value="">-- Select Operator --</option>
      <option value="eq" {% if filter_operator == 'eq' %}selected{% endif %}>Equals</option>
      <option value="contains" {% if filter_operator == 'contains' %}selected{% endif %}>Contains</option>
      <option value="gt" {% if filter_operator == 'gt' %}selected{% endif %}>Greater Than</option>
      <option value="gte" {% if filter_operator == 'gte' %}selected{% endif %}>Greater Than or Equal To</option>
      <option value="lt" {% if filter_operator == 'lt' %}selected{% endif %}>Less Than</option>
      <option value="lte" {% if filter_operator == 'lte' %}selected{% endif %}>Less Than or Equal To</option>
      <option value="between" {% if filter_operator == 'between' %}selected{% endif %}>Between</option>
    </select>

    <!-- Filter Value Inputs -->
    <input
      type="text"
      name="filter_value"
      placeholder="Filter value..."
      value="{{ filter_value or '' }}"
      class="px-4 py-2 border rounded-lg w-48"
    />

    <!-- Additional input for 'between' operator -->
    <input
      type="text"
      name="filter_value2"
      placeholder="And..."
      value="{{ filter_value2 or '' }}"
      class="px-4 py-2 border rounded-lg w-48 {% if filter_operator != 'between' %}hidden{% endif %}"
      id="filter_value2"
    />

    <button type="submit" class="bg-[#002F41] text-white px-4 py-2 rounded">
      Apply
    </button>
  </form>
</div>

<table class="min-w-full bg-white rounded-lg overflow-hidden shadow-md">
    <thead>
        <tr class="bg-[#002F41] text-white">
            {% for header in headers %}
                <th class="w-1/{{ headers|length }} text-center py-3 px-4 uppercase font-semibold text-sm">
                    {% set field = header %}
                    {% if current_sort == field %}
                    {% if current_order == 'asc' %}
                        {% set next_order = 'desc' %}
                    {% else %}
                        {% set next_order = 'asc' %}
                    {% endif %}
                    {% else %}
                    {% set next_order = 'asc' %}
                    {% endif %}
                    <a href="?sort={{ field }}&order={{ next_order }}" class="hover:underline">
                    {{ header }}
                    </a>
                </th>
            {% endfor %}
        </tr>
    </thead>
    <tbody class="text-gray-700">
        {% for row in data %}
            <tr class="{% if loop.index is even %}bg-gray-50{% endif %} hover:bg-gray-100">
                {% for field in headers %}
                    {% set key = field.lower().replace(" ", "_") %}
                    <td class="w-1/{{ headers|length }} text-center py-3 px-4">
                        {% if field == 'Status' %}
                            {% if row[key] == 'Active' %}
                                <span class="bg-green-200 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded">{{ row[key] }}</span>
                            {% elif row[key] == 'Pending' %}
                                <span class="bg-yellow-200 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded">{{ row[key] }}</span>
                            {% elif row[key] == 'Inactive' %}
                                <span class="bg-red-200 text-red-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded">{{ row[key] }}</span>
                            {% else %}
                                {{ row[key] }}
                            {% endif %}
                        {% elif field in ['Archived', 'Send Email'] %}
                            {% if row[key] == True %}
                                <span class="bg-green-200 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded">Yes</span>
                            {% else %}
                                <span class="bg-red-200 text-red-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded">No</span>
                            {% endif %}
                        {% elif field == 'Name' %}
                            <a href="/project/{{ row['id'] }}" class="text-[#0e5c6a] hover:underline">{{ row[key] }}</a>
                        {% elif field == 'Developers' %}
                            <a href="/project/{{ row['id'] }}/users" class="text-[#0e5c6a] hover:underline">{{ row[key]|length }} {{ 'Developer' if row[key]|length == 1 else 'Developers' }}</a>
                        {% elif field == 'Tasks' %}
                            <a href="/project/{{ row['id'] }}/tasks" class="text-[#0e5c6a] hover:underline">{{ row[key]|length }} {{ 'Task' if row[key]|length == 1 else 'Tasks' }}</a>
                        {% else %}
                            {{ row[key] or '' }}
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
    </tbody>
</table>

<script>
  document.querySelector('select[name="filter_operator"]').addEventListener('change', function() {
    const filterValue2 = document.getElementById('filter_value2');
    if (this.value === 'between') {
      filterValue2.classList.remove('hidden');
    } else {
      filterValue2.classList.add('hidden');
    }
  });

  window.addEventListener('DOMContentLoaded', (event) => {
    const operator = document.querySelector('select[name="filter_operator"]').value;
    const filterValue2 = document.getElementById('filter_value2');
    if (operator === 'between') {
      filterValue2.classList.remove('hidden');
    } else {
      filterValue2.classList.add('hidden');
    }
  });
</script>
{% include "pagination.html" %}

{% endblock %}